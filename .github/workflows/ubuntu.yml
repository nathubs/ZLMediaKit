name: ubuntu

on:
  push:
    tags:
      - 'v*.*.*'  # 只在以 v 开头的标签推送时触发，例如 v1.0.0

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 下载 submodule 源码
      run: mv -f .gitmodules_github .gitmodules && git submodule sync && git submodule update --init --recursive

    - name: 下载 SRTP (libsrtp)
      uses: actions/checkout@v4
      with:
        repository: cisco/libsrtp
        fetch-depth: 1
        ref: v2.3.0
        path: 3rdpart/libsrtp

    - name: 下载 usrsctp
      uses: actions/checkout@v4
      with:
        repository: sctplab/usrsctp
        fetch-depth: 1
        ref: 0.9.5.0
        path: 3rdpart/usrsctp

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential git wget cmake pkg-config autoconf automake libtool libssl-dev \
          libpam0g-dev liblz4-dev libzstd-dev nasm ca-certificates
        sudo ldconfig

    - name: Build and install usrsctp
      run: |
        set -euo pipefail
        cd 3rdpart/usrsctp
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_POSITION_INDEPENDENT_CODE=ON ..
        make -j $(nproc)
        sudo make install
        cd ../../..

    - name: Build and install libsrtp (use system OpenSSL, add -fcommon for GCC>=10)
      run: |
        set -euo pipefail
        cd 3rdpart/libsrtp
        # 对于 GCC10+ 需要 -fcommon 来兼容源码里可能将全局变量定义在头文件中的情形
        export CFLAGS="-fPIC -fcommon"
        ./configure --enable-openssl
        make -j $(nproc)
        sudo make install
        cd ../../
        sudo ldconfig

    - name: Configure & build ZLMediaKit on Ubuntu
      run: |
        set -euo pipefail
        mkdir -p linux_build
        cd linux_build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j $(nproc)
        # 将常见的可执行文件和库拷贝到 release 目录，确保后续上传
        cd ..
        mkdir -p release
        # 拷贝可执行文件（具有执行权限），以及常见库文件
        find linux_build -type f \( -perm /a=x -o -name "*.so*" -o -name "*.a" -o -name "*.so" \) -print0 | xargs -0 -I{} cp {} release/ || true
        # 也将 linux_build 下的一些产物整体拷贝作备份（如果有）
        cp -r linux_build/* release/ || true

    - name: 设置环境变量
      run: |
        echo "BRANCH=$(echo ${GITHUB_REF#refs/heads/} | tr -s "/\?%*:|\"<>" "_")" >> $GITHUB_ENV
        echo "BRANCH2=$(echo ${GITHUB_REF#refs/heads/} )" >> $GITHUB_ENV
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

    - name: Create compressed package
      id: make_archive
      run: |
        set -euo pipefail
        if [ ! -d release ] || [ -z "$(ls -A release || true)" ]; then
          echo "No files in release/ to archive" >&2
          ls -al || true
          exit 1
        fi
        ARCHIVE_NAME="${{ github.workflow }}_${{ env.DATE }}_${{ github.run_id }}.tar.gz"
        tar -czf "${ARCHIVE_NAME}" -C release .
        echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
        echo "ARCHIVE_PATH=${GITHUB_WORKSPACE}/${ARCHIVE_NAME}" >> $GITHUB_ENV
        ls -lh "${ARCHIVE_NAME}"

    - name: Upload artifact (Actions artifact, optional)
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.workflow }}_${{ env.DATE }}
        path: release/*
        if-no-files-found: error
        retention-days: 90

    - name: Create GitHub Release and upload package
      if: github.event_name != 'pull_request' && github.ref != 'refs/heads/feature/test'
      id: create_release
      uses: actions/create-release@v1
      env:
          GITHUB_TOKEN: ${{ secrets.ACCESSTOKEN }}
      with:        
        tag_name: ${{ env.BRANCH }}-${{ env.DATE }}-${{ github.run_id }}
        release_name: ${{ env.BRANCH }}-${{ env.DATE }}-${{ github.run_id }}
        body: |
          Build artifact for ${{ env.BRANCH2 }}
          - git hash: ${{ github.sha }}
          - build date: ${{ env.DATE }}
          - run id: ${{ github.run_id }}
        draft: false
        prerelease: false

    - name: Upload release asset
      if: github.event_name != 'pull_request' && github.ref != 'refs/heads/feature/test'
      uses: actions/upload-release-asset@v1
      env:
          GITHUB_TOKEN: ${{ secrets.ACCESSTOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ env.ARCHIVE_PATH }}
        asset_name: ${{ env.ARCHIVE_NAME }}
        asset_content_type: application/gzip

    - name: issue评论
      if: github.event_name != 'pull_request' && github.ref != 'refs/heads/feature/test'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.ACCESSTOKEN }}
        script: |
         const issueNumber = '${{ vars.VERSION_ISSUE_NO }}';
         if (issueNumber && issueNumber !== '') {
           github.rest.issues.createComment({
             issue_number: parseInt(issueNumber),
             owner: context.repo.owner,
             repo: context.repo.repo,
             body: '- 下载地址: [Release](' + 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/releases/tag/' + encodeURIComponent('${{ github.workflow }}-${{ env.DATE }}-${{ github.run_id }}') + ')\\n'
               + '- 分支: ${{ env.BRANCH2 }}\\n'
               + '- git hash: ${{ github.sha }} \\n'
               + '- 编译日期: ${{ env.DATE }}\\n'
               + '- 编译记录: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\\n'
               + '- 打包ci名: ${{ github.workflow }}\\n'
               + '- 开启特性: openssl/webrtc/datachannel\\n'
               + '- 说明: 本二进制在 Ubuntu 22.04 上编译，请确保目标机器为 Ubuntu（建议使用相同或兼容版本）以直接运行\\n'
          })