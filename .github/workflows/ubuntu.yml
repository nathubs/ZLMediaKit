name: Linux (Ubuntu build)

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 下载 submodule 源码
      run: mv -f .gitmodules_github .gitmodules && git submodule sync && git submodule update --init --recursive

    - name: 下载 SRTP (libsrtp)
      uses: actions/checkout@v4
      with:
        repository: cisco/libsrtp
        fetch-depth: 1
        ref: v2.3.0
        path: 3rdpart/libsrtp

    - name: 下载 usrsctp
      uses: actions/checkout@v4
      with:
        repository: sctplab/usrsctp
        fetch-depth: 1
        ref: 0.9.5.0
        path: 3rdpart/usrsctp

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential git wget cmake pkg-config autoconf automake libtool libssl-dev \
          libpam0g-dev liblz4-dev libzstd-dev nasm ca-certificates
        sudo ldconfig

    - name: Build and install usrsctp
      run: |
        set -euo pipefail
        cd 3rdpart/usrsctp
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_POSITION_INDEPENDENT_CODE=ON ..
        make -j $(nproc)
        sudo make install
        cd ../../..

    - name: Build and install libsrtp (use system OpenSSL, add -fcommon for GCC>=10)
      run: |
        set -euo pipefail
        cd 3rdpart/libsrtp
        # 对于 GCC10+ 需要 -fcommon 来兼容源码里把全局变量放在头文件的情形
        export CFLAGS="-fPIC -fcommon"
        ./configure --enable-openssl
        make -j $(nproc)
        sudo make install
        cd ../../
        sudo ldconfig

    - name: Configure & build ZLMediaKit on Ubuntu
      run: |
        set -euo pipefail
        mkdir -p linux_build
        cd linux_build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j $(nproc)