name: Linux (Ubuntu build)

on: [push, pull_request]

jobs:
  build:
    # Use an Ubuntu runner so produced binaries run directly on Ubuntu
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: 下载 submodule 源码
      run: mv -f .gitmodules_github .gitmodules && git submodule sync && git submodule update --init --recursive

    - name: 下载 SRTP (libsrtp)
      uses: actions/checkout@v4
      with:
        repository: cisco/libsrtp
        fetch-depth: 1
        ref: v2.3.0
        path: 3rdpart/libsrtp

    - name: 下载 usrsctp
      uses: actions/checkout@v4
      with:
        repository: sctplab/usrsctp
        fetch-depth: 1
        ref: 0.9.5.0
        path: 3rdpart/usrsctp

    # We will use the system OpenSSL (libssl-dev) available on Ubuntu so compiled binaries are compatible
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential git wget cmake pkg-config autoconf automake libtool libssl-dev \
          libpam0g-dev liblz4-dev libzstd-dev nasm ca-certificates
        sudo ldconfig

    - name: Build and install usrsctp
      run: |
        set -euo pipefail
        cd 3rdpart/usrsctp
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_POSITION_INDEPENDENT_CODE=ON ..
        make -j $(nproc)
        sudo make install
        cd ../../..

    - name: Build and install libsrtp (use system OpenSSL)
      run: |
        set -euo pipefail
        cd 3rdpart/libsrtp
        ./configure --enable-openssl
        make -j $(nproc)
        sudo make install
        cd ../../
        sudo ldconfig

    - name: Configure & build ZLMediaKit on Ubuntu
      run: |
        set -euo pipefail
        mkdir -p linux_build
        cd linux_build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j $(nproc)
        # Optional: install into /usr/local if you want system-wide install
        # sudo make install

    - name: 设置环境变量
      run: |
        echo "BRANCH=$(echo ${GITHUB_REF#refs/heads/} | tr -s "/\?%*:|\"<>" "_")" >> $GITHUB_ENV
        echo "BRANCH2=$(echo ${GITHUB_REF#refs/heads/} )" >> $GITHUB_ENV
        echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

    - name: 打包二进制
      id: upload
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.workflow }}_${{ env.BRANCH }}_${{ env.DATE }}
        path: release/*
        if-no-files-found: error
        retention-days: 90

    - name: issue评论
      if: github.event_name != 'pull_request' && github.ref != 'refs/heads/feature/test'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: ${{vars.VERSION_ISSUE_NO}},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '- 下载地址: [${{ github.workflow }}_${{ env.BRANCH }}_${{ env.DATE }}](${{ steps.upload.outputs.artifact-url }})\n'
              + '- 分支: ${{ env.BRANCH2 }}\n'
              + '- git hash: ${{ github.sha }} \n'
              + '- 编译日期: ${{ env.DATE }}\n'
              + '- 编译记录: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n'
              + '- 打包ci名: ${{ github.workflow }}\n'
              + '- 开启特性: openssl/webrtc/datachannel\n'
              + '- 说明: 本二进制在 Ubuntu 22.04 上编译，请确保目标机器为 Ubuntu（建议使用相同或兼容版本）以直接运行\n'
          })